steps:
  # 1. Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'europe-west4-docker.pkg.dev/prueba-track-devops-mmog/webapp-repo/webapp:v2'
      - '.' # Point to the webapp directory as the build context
    id: 'Build'

  # 2. Push the container image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'europe-west4-docker.pkg.dev/prueba-track-devops-mmog/webapp-repo/webapp:v2'
    id: 'Push'

  # 3. Deploy to GKE
  # First, get the credentials for the GKE cluster
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'container'
      - 'clusters'
      - 'get-credentials'
      - 'webapp-cluster'
      - '--location'
      - 'europe-west4'
      - '--project'
      - 'prueba-track-devops-mmog'
    id: 'Get GKE Credentials'

  # Now, update the deployment to use the new image
  - name: 'gcr.io/cloud-builders/kubectl'
    args:
      - 'set'
      - 'image'
      - 'deployment/webapp-deployment'
      - 'webapp=europe-west4-docker.pkg.dev/prueba-track-devops-mmog/webapp-repo/webapp:v2'
      - '--namespace'
      - 'webapp'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=europe-west4'
      - 'CLOUDSDK_CONTAINER_CLUSTER=webapp-cluster'
    id: 'Deploy to GKE'

images:
  - 'europe-west4-docker.pkg.dev/prueba-track-devops-mmog/webapp-repo/webapp:v2'
